/*
Pratica 1: Implementacao de um Middleware tolerante a falha para alocacao dinamica de memoria
Alunos: Ellen Priscila Borges Oliveira RA 69554
        Juliana de Paula Nader RA 86301
*/

#define _GNU_SOURCE
#include <stdio.h>
#include <stdlib.h>
#include <dlfcn.h>


typedef struct no_lista{
  void * p_fun;
  size_t size;
  struct no_lista *ant; /* quarda a posicao do elemento anterior na lista */
  struct no_lista *prox; /* quarda a posicao do proximo elemento na lista */
}NO;

typedef struct Lista{
    NO* primeiro;
    NO* ultimo;
    int tamanho;     /*guarda o tamanho da lista*/
}LDE;

/*----------------- Funcoes para a Lista encadeada-----------------*/

void InicializaLista(LDE *L){
  L->primeiro = NULL;
  L->ultimo = NULL;
  L->tamanho = 0;

}

NO* Busca(LDE *L, void * p_fun){

    NO *temp;
    for (temp = L->primeiro; temp!=NULL;temp = temp->prox) {
        if (temp->p_fun == p_fun) {
          return temp;
        }
    }
    return NULL; /* não achou o no */
}

NO* CriaNovoNo(void * p_fun, size_t size){
    NO *novo = malloc(sizeof(NO));
    novo->p_fun = p_fun;
    novo->size = size;
    novo->ant = NULL;
    novo->prox = NULL;
    return novo;
}


//insere um novo no no final da lista
int InsereNO(LDE *L, void * p_fun, size_t size){ //void(*dado)() ){
    NO*novo = CriaNovoNo(p_fun,size);
    if(novo==NULL)
        return -1;
    //se a lista esta vazia
    if(L->primeiro==NULL && L->ultimo==NULL){
        L->primeiro = novo;
        L->ultimo = novo;
        L->tamanho++;
        return 0;
    }
    //caso a lista possua um ou mais elementos
    else{
        if(Busca(L,p_fun)==NULL){
            novo->prox = NULL;
            novo->ant= L->ultimo;
            L->ultimo->prox = novo;
            L->ultimo = novo;
            L->tamanho++;
            return 0;
        }else return -1;
    }
}

int RemoveNO(LDE *L, void * p_fun){
    if(L->tamanho==0) //se a lista esta vazia
        return -1;
    NO* temp = Busca(L,p_fun);
    if(temp!=NULL){
        //remove começo
        if(temp->ant==NULL){
            L->primeiro = temp->prox;
            L->primeiro->ant = NULL;

        }//remove final
        else if(temp->prox==NULL){
            L->ultimo= temp->ant;
            temp->ant->prox=NULL;
            L->tamanho--;

        }//no meio
        else {
            temp->ant->prox = temp->prox;
            temp->prox->ant = temp->ant;

        }
        L->tamanho--;
        temp->prox = NULL;
        temp->ant= NULL;
        free(temp);
        return 0;
    }else return -1;

}

void DestroiLista(LDE* L){
    NO* no = L->primeiro;
    NO* temp;

    while (no != NULL) {
        temp = no->prox;
        free(no);
        no = temp;
    }
    free(L);
}
void ImprimeLista (LDE *L) {
    if(L!=NULL){
        Imprime(L->primeiro);
    }
}

void Imprime(NO* temp){

    if(temp!=NULL){
        printf("Endereco = [%p]\n", temp->p_fun);
        printf("Tamanho = [%d]\n", temp->size);
        Imprime(temp->prox);
    }
}

/*----------------- Funcoes para o mid-----------------*/
/*

void *(*_malloc)(size_t) = NULL;

void *malloc(size_t size){

	if (!_malloc)
		_malloc = dlsym(RTLD_NEXT, "malloc");

    void *p = _malloc(size);
	fprintf(stderr, "WRAPPER: malloc(%d) = %p\n",(int)size, p);
	

	InsereNO(lista,p,size);
	
	
	return p;
}

void * (*_calloc)(size_t, size_t) = NULL;

void *calloc(size_t nmemb, size_t size){
	if (!_calloc)
		_calloc = dlsym(RTLD_NEXT, "calloc");

    void *p = _calloc(nmemb, size);
	fprintf(stderr, "WRAPPER: calloc(%d) = %p\n",(int)size, p);
	

	InsereNO(lista,p,size);
	return p;

}


void * (*_realloc)(void *, size_t) = NULL;

void *realloc(void *ptr, size_t size){
	if (!_realloc)
		_realloc = dlsym(RTLD_NEXT, "realloc");
		
    void *p = _realloc(ptr, size);
	fprintf(stderr, "WRAPPER: realloc(%d) = %p\n",(int)size, p);
	

	InsereNO(lista,p,size);
	return p;


}



void (*_free)(void *) = NULL;

void free(void *ptr){
	if(_free ==NULL){
		_free = dlsym (RTLD_NEXT,"free");
	
	void *p = Busca(ptr);
	if(p!NULL){
        RemoveNO(lista,p)
        _free(p);
	}

}
*/


int main(){
    LDE *lista  = malloc(sizeof(LDE));
    InicializaLista(lista);
    InsereNO(lista,7,10);
    InsereNO(lista,2,1);
    InsereNO(lista,5,10254);

    ImprimeLista(lista);
    RemoveNO(lista,2);
    printf("remove\n");
    ImprimeLista(lista);


return 0;

}





